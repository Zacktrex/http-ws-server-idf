<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>ESP-RS WebSocket Server</title>
<script>
// Prevent offline page caching
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
        }
    });
}
// Force reload if page was loaded from cache
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        window.location.reload();
    }
});
</script>
<style type="text/css">
body {
	max-width: 50em;
	margin: auto;
	padding: 1em;
	font: 1em/1.65 sans-serif;
}
input {
    width: 100%;
    height: 3em;
    margin-bottom: 1em;
}
.section {
    margin-top: 2em;
    padding: 1em;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: #fafafa;
}
.section h2 {
    margin-top: 0;
}
textarea {
    width: 100%;
    min-height: 4em;
    margin-bottom: 1em;
    font-family: inherit;
    font-size: 1em;
    padding: 0.5em;
    box-sizing: border-box;
}
</style>
</head>
<body onload="loadWebSocket()">
<form id="the-form" action="/post" accept-charset="utf-8">
<label for="user-text">Make a guess:</label>
<input type="text" id="user-text" name="user_text"><br>
<input type="submit" id="user-submit" value="Submit" disabled>
</form>
<p id="server-resp">Connecting...</p>

<div class="section">
    <h2>OLED Display Message</h2>
    <form id="display-form">
        <label for="display-text">Enter message to display on OLED:</label>
        <textarea id="display-text" name="display_text" placeholder="Type your message here..."></textarea>
        <input type="submit" id="display-submit" value="Send to OLED" disabled>
    </form>
    <p id="display-resp" style="margin-top: 0.5em; color: #666;">Connecting to display WebSocket...</p>
</div>

<div id="rssi-info" style="margin-top: 1em; padding: 0.5em; background-color: #f0f0f0; border-radius: 4px;">
    <strong>Signal Info:</strong><br>
    RSSI: <span id="rssi-value">--</span> dBm<br>
    Distance: <span id="distance-value">--</span> meters
</div>
<script type="text/javascript">

const submitButton = document.getElementById("user-submit");
const theForm = document.getElementById("the-form");
const userText = document.getElementById("user-text");
const serverResp = document.getElementById("server-resp");

const displaySubmitButton = document.getElementById("display-submit");
const displayForm = document.getElementById("display-form");
const displayText = document.getElementById("display-text");
const displayResp = document.getElementById("display-resp");

let ws;
let wsDisplay;
let rssiInterval = null;
// Unique connection ID for this tab (to prevent cross-tab interference)
const connectionId = Math.random().toString(36).substring(7);
console.log('Tab connection ID:', connectionId);

function loadWebSocket() {
    // First, test if server is reachable
    const host = window.location.host;
    console.log('Testing server connection to:', host);
    serverResp.innerText = 'Connecting to server...';
    
    // Test HTTP connection first with health endpoint
    fetch('/health')
        .then(response => {
            if (response.ok) {
                return response.text();
            } else {
                throw new Error('Server returned error: ' + response.status);
            }
        })
        .then(data => {
            console.log('Server is reachable via HTTP. Response:', data);
            connectWebSockets();
        })
        .catch(error => {
            console.error('Cannot reach server:', error);
            serverResp.innerHTML = 'Cannot connect to server.<br>Please check:<br>1. You are connected to ESP32 WiFi network<br>2. Server IP is correct (try http://192.168.71.1 or http://192.168.4.1)<br>3. Server is running<br>4. Try hard refresh (Ctrl+F5)';
            submitButton.disabled = true;
        });
}

function connectWebSockets() {
    const host = window.location.host;
    console.log('Connecting WebSockets to:', host);
    
    // Close any existing connections first
    if (ws && ws.readyState !== WebSocket.CLOSED) {
        console.log('Closing existing game WebSocket connection');
        ws.close();
    }
    if (wsDisplay && wsDisplay.readyState !== WebSocket.CLOSED) {
        console.log('Closing existing display WebSocket connection');
        wsDisplay.close();
    }
    
    // Game WebSocket
    ws = new WebSocket(`ws://${host}/ws/guess`);
    // Store connection ID on the WebSocket object for verification
    ws._connectionId = connectionId;
    
    ws.onopen = function(e) {
        console.log(`[${connectionId}] Game WebSocket connected, readyState:`, this.readyState);
        // Verify this is still our current WebSocket
        if (ws && ws === this && ws._connectionId === connectionId) {
            if (this.readyState === WebSocket.OPEN) {
                submitButton.disabled = false;
                serverResp.innerText = 'Connected! Enter your guess.';
                updateRSSI(); // Initial RSSI update
                // Clear any existing interval before setting a new one
                if (rssiInterval) {
                    clearInterval(rssiInterval);
                }
                rssiInterval = setInterval(updateRSSI, 2000); // Update every 2 seconds
            } else {
                console.warn(`[${connectionId}] WebSocket opened but readyState is not OPEN:`, this.readyState);
                submitButton.disabled = true;
                serverResp.innerText = 'Connection opened but not ready. Please refresh.';
            }
        } else {
            console.warn(`[${connectionId}] Ignoring open event from stale WebSocket`);
        }
    };
    ws.onclose = function(e) {
        console.log(`[${connectionId}] Game WebSocket closed. Code:`, e.code, 'Reason:', e.reason);
        // Only disable button if this is our own connection closing
        // Check if this is still the current WebSocket (not a stale reference)
        if (ws && ws === this && ws._connectionId === connectionId) {
            submitButton.disabled = true;
            // Clear RSSI interval when connection closes
            if (rssiInterval) {
                clearInterval(rssiInterval);
                rssiInterval = null;
            }
            // Only show error message if it wasn't a normal closure (code 1000)
            if (e.code !== 1000 && e.code !== 1001) {
                serverResp.innerText = 'Connection closed. Error code: ' + (e.code || 'unknown') + '. Please refresh the page.';
            } else {
                serverResp.innerText = 'Connection closed. Please refresh to reconnect.';
            }
        } else {
            console.log(`[${connectionId}] Ignoring close event from stale WebSocket connection`);
        }
    };
    ws.onerror = function(e) {
        console.error(`[${connectionId}] Game WebSocket error for this tab only`, e);
        // Only disable button if this is our own connection
        if (ws && ws === this && ws._connectionId === connectionId) {
            submitButton.disabled = true;
            serverResp.innerText = 'Connection error. Check console for details.';
        } else {
            console.log(`[${connectionId}] Ignoring error from stale WebSocket`);
        }
    };
    ws.onmessage = function(e) {
        console.log(`[${connectionId}] Game message received:`, e.data);
        // Only process if this is our current WebSocket
        if (ws && ws === this && ws._connectionId === connectionId && this.readyState === WebSocket.OPEN) {
            serverResp.innerText = e.data;
            // Ensure button stays enabled when receiving messages
            submitButton.disabled = false;
        } else {
            console.log(`[${connectionId}] Ignoring message from stale WebSocket connection`);
        }
    };
    
    // OLED Display WebSocket
    wsDisplay = new WebSocket(`ws://${host}/ws/display`);
    wsDisplay.onopen = function(e) {
        console.log('Display WebSocket connected');
        displaySubmitButton.disabled = false;
        displayResp.innerText = 'Connected! Enter a message to display on OLED.';
        displayResp.style.color = '#006400';
    };
    wsDisplay.onclose = function(e) {
        console.log('Display WebSocket closed', e);
        displaySubmitButton.disabled = true;
        displayResp.innerText = 'Connection closed. Please refresh the page.';
        displayResp.style.color = '#666';
    };
    wsDisplay.onerror = function(e) {
        console.error('Display WebSocket error', e);
        displaySubmitButton.disabled = true;
        displayResp.innerText = 'Connection error. OLED may not be available.';
        displayResp.style.color = '#d00';
    };
    wsDisplay.onmessage = function(e) {
        console.log('Display message received:', e.data);
        displayResp.innerText = e.data;
        if (e.data.includes('Error')) {
            displayResp.style.color = '#d00';
        } else {
            displayResp.style.color = '#006400';
        }
    };
}

function updateRSSI() {
    fetch('/rssi')
        .then(response => response.json())
        .then(data => {
            const rssiElement = document.getElementById('rssi-value');
            const distanceElement = document.getElementById('distance-value');
            
            if (data.rssi !== null) {
                rssiElement.textContent = data.rssi;
                distanceElement.textContent = data.distance.toFixed(2);
            } else {
                rssiElement.textContent = 'N/A';
                distanceElement.textContent = 'N/A';
            }
        })
        .catch(error => {
            console.error('Error fetching RSSI:', error);
            document.getElementById('rssi-value').textContent = 'Error';
            document.getElementById('distance-value').textContent = 'Error';
        });
}

theForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    // Verify this is our current WebSocket connection
    if (ws && ws._connectionId === connectionId && ws.readyState === WebSocket.OPEN) {
        ws.send(userText.value);
        userText.value = ''; // Clear input after sending
    } else {
        console.warn(`[${connectionId}] WebSocket not open or wrong connection, attempting to reconnect...`);
        serverResp.innerText = 'Not connected. Please refresh the page.';
        submitButton.disabled = true;
        // Try to reconnect
        connectWebSockets();
    }
});

displayForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = displayText.value.trim();
    if (message && wsDisplay && wsDisplay.readyState === WebSocket.OPEN) {
        wsDisplay.send(message);
        displayText.value = ''; // Clear input after sending
        displayResp.innerText = 'Sending...';
        displayResp.style.color = '#666';
    } else if (!message) {
        displayResp.innerText = 'Please enter a message.';
        displayResp.style.color = '#d00';
    } else {
        displayResp.innerText = 'Not connected. Please refresh the page.';
        displayResp.style.color = '#d00';
    }
});

</script>
</body>
</html>
